<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Игры</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/moon.css" id="theme">
        <link rel="stylesheet" href="custom.css">
		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

        <style>
            .left {
                float: left;
            }
            .right {
                float: right;
            }
            .clear {
                clear: both;
            }

            #game_matrix table td {
                border: 1px solid black;
                cursor: pointer;
                width: 100px;
                height: 100px;
            }

            #game_matrix #name {
                width: 100%;
                height: 40px;
                line-height: 40px;
                font-size: 18px;
            }

            #game_matrix #find {
                width: 100%;
                height: 120px;
                line-height: 120px;
                border: 1px solid black;
            }

            #game_matrix #start {
                width: 100%;
                height: 40px;
                line-height: 40px;
                font-size: 18px;
                color: black;
                background-color: coral;
            }

            #score {
                font-size: 80%;
            }

            #table {
                overflow-y: scroll;
                height: 500px;
            }

            .flex {
                display: flex;
            }

            #pingpong #field {
			width: 720px;
		}
		#pingpong #joystick {
			/* border: 1px solid black; */
			margin: 0 auto;
			width: 240px;
		}
		#pingpong input[type=range][orient=vertical] {
			appearance: slider-vertical;
			width: 100%;
			height: 540px;
			padding: 0 5px;
		}
		#pingpong #gamer {
			height: 40px;
			width: 300px;
			line-height: 40px;
			font-size: 19pt;
		}
		#pingpong #game_ping_pong_start {
			height: 40px;
			width: 300px;
			line-height: 40px;
			font-size: 19pt;
		}
        </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown class="center">
                    <script type="text/template">
                        Игры
                        ======
                    </script>
                </section>

                    <section data-markdown>
                    <script type="text/template">
                        Игра - занятие, обусловленное совокупностью определенных правил, приемов и служащее для заполнения досуга, развлечения.
                    </script>
                </section>


                <section data-markdown class="center">
                    <script type="text/template">
                        ## Компьютерная игра
                    </script>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ### Компьютерная игра
                        1. Взаимодействие по определенному алгоритму 
                        (с целью развлечения, обучения, или тренировки) человека 
                        (группы людей) с компьютером или группы людей с друг другом посредством компьютера.
                    </script>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ### Компьютерная игра
                        2. Комьютерная программа, которая организует игровой процесс и управляет им,
                        а также осуществляет взаимодействие между соперниками и партнерами по игре или
                        сама выступает в качестве игрока.
                    </script>
                </section>
                
                <section data-markdown>
                    <script type="text/template">
                        ### Компьютерная игра
                        В процессе игры на экране дисплея наглядно отображается
                        игровая ситауция. Анализируя эту ситуацию, играющий реагирует на нее с помощью устройств ввода
                        (клавиатуры, мыми, джойстика и др.). Ответные ходы или соответсвующее изменение игровой ситуации
                        компьютер воспроизводит на экране, часто со звуковым сопровождением.
                    </script>
                </section>
                <section data-markdown class="center">
                    <script type="text/template">
                        ## Игра 1. Скоростная матрица
                    </script>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ### Игра 1. Скоростная матрица
                        Правила игры: игра состоит из 25 ячеек (5х5), ячейки раскрашены в 7 цветов:
                        красный, зеленый, голубой, черный, белый, желтый и случайный цвет. 24 ячейки
                        раскрашиваются в 6 разных цветов по 4 ячейки каждый. 1 ячейка уникального
                        цвета. С интервалом 800мс ячейки будут перемешиваться. Нужно среди всех
                        других цветов отыскать ячеку с уникальным цветом и кликнуть на нее, пока
                        ячейки снова не перемешались.
                    </script>
                </section>

            <section data-markdown>
                <script type="text/template">
                    ### Игра 1. Скоростная матрица
                    Начисление очков: за каждую правильную кликнутую ячейку игрот получает 1200
                    баллов + количество оставшихся миллисекунд до перемешивания матрицы. При
                    ошибочном нажатии вычитается 1200 баллов + количество оставшихся миллисекунд до
                    смену матрицы.
                </script>
                </section>
                <section data-markdown>
                <script type="text/template">
                    ### Игра 1. Скоростная матрица
                    Длительность раундов:
                    1. 15 секунд
                    2. 30 секунд
                    3. 45 секунд
                </script>
                </section>

                <section id="game_matrix">
                    <h3>Игра1. Скоростная матрица</h3>
                    <div id="wrapper">
                    <div id="field" class="left"></div>
                    <div id="info" class="right">
                        <div>
                            <input type="text"
                            id="name"
                            value="kate"></div>
                            <div id="round"></div>
                            <div id="time"></div>
                            <div id="find">Цвет ячейки</div>
                            <div id="score"></div>
                            <div>
                                <input type="button" id="start" value="Начать игру">
                            </div>
                        
                    </div>
                    <div class="clear"></div>
                    </div>
                </section>

                <section id="game_matrix_table">
                    <h3>Турнирная таблица</h3>
                    <div id="table"></div>
                </section>

                <section data-markdown class="center">
                    <script type="text/template">
                    ## Игра 2. Пинг-понг
                    </script>
                </section>

                <section data-markdown>
                    <script type="text/template">
                    ## Игра 2. Пинг-понг
                    Правила игры: игровое поле разделено на две части. Слева и справа находятся
                    двигающиеся вверх и вниз ракетки игроков, которые отбивают шар по
                    линейной траектории. В случае если шар был отбит, он меняет свою траекторию.
                    Если шар улетел за пределы игрового поля, одно очко достается тому, кто отбил этот шар последним.              
                    </script>
                        </section>

                        <section data-markdown>
                            <script type="text/template">
                            ## Игра 2. Пинг-понг
                            Начисление очков: 1 очко, выигравшему раунд.
                            Длительность: до первой ошибки игрока. Игра до 3х очков.
                        </script>
                    </section>

                    <section id="pingpong">
                        <h3>Игра 2. Пинг-понг</h3>
                        <div class="flex">
                            <div id="field">
                                <input type="name" id="gamer" value="renard" >
                                <input type="button" id="game_ping_pong_start" value="Присоедениться к игре" >
                                <canvas id="game_ping_pong" width="720" height="480"></canvas>
                            </div>
                            <div id="joystick">
                                <input type="range" min="75" max="480" value="240" orient="vertical" disabled/>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3>Веселые картинки</h3>
                        <img src="https://images.hindustantimes.com/rf/image_size_630x354/HT/p2/2018/05/16/Pictures/_1571873a-58de-11e8-b431-73159b4b09e2.jpg" >
                    </section>

                    <section data-background-image="doggie.jpg"
                    data-menu-title="dog"
                    data-background-size="contain">
                </section>

                    <section data-markdown class="center">
                        <script type="text/template">
                           Спасибо за внимание
                        </script>
                        </section>



			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>

        <script src="https://game.9pr.ru/socket.io/socket.io.js"></script>

        <script src="pingpong/easel.js"></script>
	    <script src="pingpong/Tween.js"></script>

		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
                center: false,
                slideNumber: true,
                controls: true,
                dependencies: [
                    {
                        src: 'plugin/menu/menu.js'
                    }
                ],
                menu: {
                    numbers: true,
                    markers: true,
                },
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
        <script>

            class GameMatrix{
                constructor () {
                    this.field = '';
                    this.colors = [];
                }
                genereteColors(colors) {
                    let num = randomInteger(6);
                    this.find = colors[num];
                    for (let i = 0; i < 7; i++) {
                        this.colors = this.colors.concat(Array(i == num ? 1 : 4).fill(colors[i]));
                    }
                    console.log(this.colors);
                    return this;
                }

            setFindColor (element) {
                element.style.backgroundColor = this.find;
                return this;
            }
            generateField () {
                this.field = `<table>`;
                for (let i = 0; i < 5; i++) {
                    this.field += `<tr>`
                    for (let j = 0; j < 5; j++) {
                        this.field += `<td style="background: ${this.colors[i*5+j]}"></td>`;
                    }
                    this.field += `</tr>`
                }
                this.field += `
                </table>
                `;
                return this;
            }

            fillField(element) {
                element.innerHTML = this.field;
                return this;
            }

            shuffled () {
                for (let i = this.colors.length - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    [this.colors[i], this.colors[j]] =
                    [this.colors[j], this.colors[i]];
                }
                return this;
            }

            updateField (tds) {
                for (let i = 0; i < this.colors.length; i++) {
                    tds[i].style.backgroundColor = this.colors[i];
                }
                return this;
            }
        }

            function randomInteger(max) {
               return Math.floor(Math.random()*(max +1));
            }

            function randomRgbColor () {
                let r = randomInteger(255);
                let g = randomInteger(255);
                let b = randomInteger(255);
                return `rgb(${r}, ${g}, ${b})`;
            }

            let colors = [
                'rgb(255, 0, 0)',
                'rgb(0, 255, 0)',
                'rgb(0, 0, 255)',
                'rgb(255, 255, 0)',
                'rgb(255, 255, 255)',
                'rgb(34, 34, 34)',
            ];

            colors.push(randomRgbColor());

            let timeScore = 0;
            const getScore = () => {
                socketMatrix = io('http://game.9pr.ru/matrix');
                socketMatrix.emit('getScore', (table) => {
                    console.log(table);
                    let scoreTable = `<table><thead><tr><th>Место</th><th>Ник</th><th>Баллы</th></thead></tbody>`;
                        for (let i in table) {
                            scoreTable += `<tr><th>${+i+1}</th><th>${table[i].name}</th><th>${table[i].score}</th></thead><tbody>`;
                        }
                        scoreTable += `</tbody></table>`;
                        document.querySelector('#game_matrix_table #table').innerHTML = scoreTable;
                });
            }

            let canvas;
	let stage;
	let container = new Container();
	let bgImg = new Image();
	let bg;
	let leftPlayerImg = new Image();
	let leftPlayer;
	let rightPlayerImg = new Image();
	let rightPlayer;
	let ballImg = new Image();
	let ball;
	let leftPlayerScore;
	let rightPlayerScore;
	let xSpeed = 5;
	let ySpeed = 5;
	let gfxLoaded = 0;
	let tkr = new Object;
	let x = 480*1.5;
	let y = 320*1.5;
	let ballSize = 30;
	let collisionX = 22;
	let collisionY = 75;
	let scoreTotal = 3;
	let side = 'right';
	function pingPongMain(element) {
		canvas = element;
		stage = new Stage(canvas);
		stage.mouseEventsEnabled = true;
		bgImg.src = 'pingpong/bg.png';
		bgImg.name = 'bg';
		bgImg.onload = loadGfx;
		leftPlayerImg.src = 'pingpong/paddle.png';
		leftPlayerImg.name = 'leftPlayer';
		leftPlayerImg.onload = loadGfx;
		ballImg.src = 'pingpong/ball.png';
		ballImg.name = 'ball';
		ballImg.onload = loadGfx;
		rightPlayerImg.src = 'pingpong/paddle.png';
		rightPlayerImg.name = 'rightPlayer';
		rightPlayerImg.onload = loadGfx;
		Ticker.setFPS(30);
		Ticker.addListener(stage);
		///////////////////////////
		socketPingPong = io("http://game.9pr.ru/pingpong");
		socketPingPong.on('connect', () => {
			socketPingPong.emit("createField", ''+Math.floor(Math.random()*9999999));
			socketPingPong.on("wait", (body) => {
				if (Object.keys(body.gamers).length == 1) {
					leftPlayerWait.online = true;
					side = 'left';
				}
				if (Object.keys(body.gamers).length == 2) {
					leftPlayerWait.online = true;
					rightPlayerWait.online = true;
				}
				waitGameStart();
			});
			socketPingPong.on("getY", (body) => {
				console.log(body);
				if (body.gamer !== document.querySelector('#gamer').value) {
					if (side === 'left') {
						rightPlayer.y = y - body.y;
					} else {
						leftPlayer.y = y - body.y;
					}
				}
			});
		});
		/////////////////////////////////////
	}
	function loadGfx(e) {
		if(e.target.name = 'bg'){bg = new Bitmap(bgImg);}
		if(e.target.name = 'leftPlayer'){leftPlayer = new Bitmap(leftPlayerImg);}
		if(e.target.name = 'ball'){ball = new Bitmap(ballImg);}
		if(e.target.name = 'rightPlayer'){rightPlayer = new Bitmap(rightPlayerImg);}
		gfxLoaded++;
		if(gfxLoaded == 4) {
			addGameView();
		}
	}
	function addGameView() {
		stage.addChild(bg, container);
		leftPlayer.x = 2;
		leftPlayer.y = y/2 - collisionY/2;
		rightPlayer.x = x - 25;
		rightPlayer.y = y/2 - collisionY/2;
		ball.x = x/2 - ballSize/2;
		ball.y = y/2 - ballSize/2;
		leftPlayerWait = new Text('Ожидание игрока', 'bold 28px Arial', '#A3FF24');
		leftPlayerWait.maxWidth = 1000;
		leftPlayerWait.x = 60;
		leftPlayerWait.y = y/3;
		leftPlayerWait.online = false;
		rightPlayerWait = new Text('Ожидание игрока', 'bold 28px Arial', '#A3FF24');
		rightPlayerWait.maxWidth = 1000;
		rightPlayerWait.x = x/2+60;
		rightPlayerWait.y = y/3;
		rightPlayerWait.online = false;
		leftPlayerScore = new Text('0', 'bold 28px Arial', '#A3FF24');
		leftPlayerScore.maxWidth = 1000;
		leftPlayerScore.x = x/2 - 30;
		leftPlayerScore.y = 30;
		rightPlayerScore = new Text('0', 'bold 28px Arial', '#A3FF24');
		rightPlayerScore.maxWidth = 1000;
		rightPlayerScore.x = x/2 + 10;
		rightPlayerScore.y = 30;
		stage.addChild(leftPlayerWait, rightPlayerWait, leftPlayerScore, rightPlayerScore, leftPlayer, rightPlayer, ball);
		stage.update();
	}


            window.onload = () => {
                let gameMatrix = new GameMatrix();

                if (sessionStorage.getItem('game_matrix_round') === null) {
                    sessionStorage.setItem('game_matrix_round', 1);
                }
                document.querySelector('#game_matrix #round').innerHTML = `Раунд
                ${sessionStorage.getItem('game_matrix_round')}`;

                gameMatrix.genereteColors(colors).setFindColor(document.querySelector('#game_matrix #find')).shuffled().generateField().fillField(document.querySelector('#game_matrix #field'));
                
                document.querySelector('#game_matrix #start').onclick = () => {
                    if (document.querySelector('#game_matrix #name').value.trim() == '')
                    {
                        return alert('Введите Ваше имя');
                    }
                    
                    
                    const scoreCount = (e) => {
                        console.log(e);
                        if (gameMatrix.find === e.target.style.backgroundColor) {
                            sessionStorage.setItem('game_matrix_score',
                            +sessionStorage.getItem('game_matrix_score') + 1200 + timeScore);
                        } else {
                            sessionStorage.setItem('game_matrix_score',
                            +sessionStorage.getItem('game_matrix_score') - 1200 - 800 + timeScore);
                        }

                        gameMatrix.shuffled().updateField(document.querySelectorAll('#game_matrix #field td'));
                        clearInterval(interval);

                        document.querySelector('#game_matrix #score').innerHTML = `Результат <br> ${sessionStorage.getItem('game_matrix_score')} баллов`;
                    }
                    socket = io("http://game.9pr.ru/matrix");
                    if (sessionStorage.getItem('game_matrix_score') == null) {
                        sessionStorage.setItem('game_matrix_score', 0);
                    }
                    document.querySelector('#game_matrix #score').innerHTML = `
                    Результат <br> ${sessionStorage.getItem('game_matrix_score')} баллов
                    `;
                    const timeRound = [0, 5, 5, 5];
                    let timeRemained = timeRound[sessionStorage.getItem('game_matrix_round')] * 1000;
                    document.querySelector('#game_matrix #time').innerHTML = `
                    Ост. время <br> ${timeRound[sessionStorage.getItem('game_matrix_round')]}c.
                    `;

                    timeScore = 800;
                    let interval = setInterval(
                        () => {
                            if (timeRemained <= 0) {
                                clearInterval(interval);
                            } else {
                                gameMatrix.shuffled().updateField(document.querySelectorAll('#game_matrix #field td'));
                            }
                        }, 800
                    );
                    let time = setInterval (() => {
                        timeRemained -=10;
                        timeScore -=10;
                        if (timeRemained <= 0) {
                            clearInterval(time);
                            document.querySelector('#game_matrix table').removeEventListener('click', scoreCount);
                            document.querySelector('#game_matrix #start').style.display = 'block';
                            document.querySelector('#game_matrix #time').innerHTML = '';
                            if (sessionStorage.getItem('game_matrix_round') < 3) {
                                sessionStorage.setItem('game_matrix_round', +sessionStorage.getItem('game_matrix_round')+1);
                            }
                            else {
                                sessionStorage.setItem('game_matrix_round', 1);
                                socket.emit('sendScore', {
                                    name: document.querySelector('#game_matrix #name').value.trim(),
                                    score: sessionStorage.getItem('game_matrix_score'),
                                });
                                sessionStorage.setItem('game_matrix_score', 0);
                                Reveal.next();
                            }
                            document.querySelector('#game_matrix #round').innerHTML = 'Раунд' + sessionStorage.getItem('game_matrix_round');
                        } else {
                            document.querySelector('#game_matrix #start').style.display = 'none';
                            document.querySelector('#game_matrix #time').innerHTML = `Ост. время <br> ${timeRemained/1000}c`;
                        }
                    }, 10);

                    if (sessionStorage.getItem('game_matrix_round') == 1) {
                        sessionStorage.setItem('game_matrix_score', 0);
                    }
                    document.querySelector('#game_matrix table').addEventListener('click', scoreCount);
                }
                getScore();
                Reveal.on('slidechanged', (e) => {
                    if (e.currentSlide.id == 'game_matrix_table') {
                        getScore();
                    }
                });


                pingPongMain(document.querySelector('#game_ping_pong'));
		document.querySelector('#game_ping_pong_start').onclick = () => {
			document.querySelector('#gamer').disabled = true;
			document.querySelector('#game_ping_pong_start').disabled = true;
			socketPingPong.emit('join', {
				gamer: document.querySelector('#gamer').value,
			}, (body) => {
				if (body.error !== undefined) {
					alert(body.error);
				}
			});
		};
		////################
		document.querySelector('#joystick input').addEventListener("input", movePaddle);
		////################
            }

            /// Выше ///
	function waitGameStart() {
		if (leftPlayerWait.online) {
			stage.removeChild(leftPlayerWait);
		}
		if (rightPlayerWait.online) {
			stage.removeChild(rightPlayerWait);
		}
		if (leftPlayerWait.online && rightPlayerWait.online) {
			let digits = ['0', '1', '2', '3'];
			threeTwoOneStart = new Text(digits.pop(), 'bold 48px Arial', '#A3FF24');
			threeTwoOneStart.maxWidth = 1000;
			threeTwoOneStart.x = x/2 - 15;
			threeTwoOneStart.y = y/3;
			stage.addChild(threeTwoOneStart);
			let interval = setInterval(() => {
				threeTwoOneStart.text = digits.pop();
				stage.update(); 
				if (+threeTwoOneStart.text === 0) {
					clearInterval(interval);
					stage.removeChild(threeTwoOneStart);
					document.querySelector('#joystick input').disabled = false;
					startGame();
				}
			}, 1000);
		}
	}
	function startGame(e) {
		bg.onPress = null;
		Ticker.addListener(tkr, false);
		tkr.tick = updateTick;
	}
	function updateTick() {
		ball.x = ball.x + xSpeed;
		ball.y = ball.y + ySpeed;
		if((ball.y) < 0) { ySpeed = -ySpeed;};
		if((ball.y + ballSize) > y) { ySpeed = -ySpeed;};
		if(ball.x + ballSize > rightPlayer.x && ball.x + ballSize < rightPlayer.x + collisionX && ball.y >= rightPlayer.y && ball.y < rightPlayer.y + collisionY) {
			xSpeed *= -1;
		}
		if(ball.x <= leftPlayer.x + collisionX && ball.x > leftPlayer.x && ball.y >= leftPlayer.y && ball.y < leftPlayer.y + collisionY) {
			xSpeed *= -1;
		}
		if((ball.x) < 0) {
			xSpeed = -xSpeed;
			rightPlayerScore.text = +rightPlayerScore.text + 1;
			resetField();
		}
		if((ball.x + ballSize) > x) {
			xSpeed = -xSpeed;
			leftPlayerScore.text = +leftPlayerScore.text + 1;
			resetField();
		}
	}
	////################ Выше
	function resetField(){
		document.querySelector('#joystick input').disabled = true;
		ball.x = x/2 - ballSize/2;
		ball.y = y/2 - ballSize /2;
		leftPlayer.y = y/2 - collisionY/2;
		rightPlayer.y = y/2 - collisionY/2;
		stage.onMouseMove = null;
		Ticker.removeListener(tkr);
		if (checkWin()) {
			waitGameStart();
		}
		//bg.onPress = startGame;
	}
	function checkWin() {
		if(+leftPlayerScore.text === scoreTotal){
			document.querySelector('#gamer').disabled = false;
			document.querySelector('#game_ping_pong_start').disabled = false;
			return whoIsWinner('Победа левого', 'left');
		} else if(+rightPlayerScore.text === scoreTotal) {
			document.querySelector('#gamer').disabled = false;
			document.querySelector('#game_ping_pong_start').disabled = false;
			return whoIsWinner('Победа правого', 'right');
		}
		return true;
	}
	function whoIsWinner(winner, cite) {
		Ticker.removeListener(tkr);
		stage.onMouseMove = null;
		bg.onPress = null
	
		e = new Text(winner, 'bold 28px Arial', '#A3FF24');
		e.maxWidth = 1000;
		e.x = cite === 'left' ? 70 : x/2 + 70;
		e.y = 3*y/4;
		stage.addChild(e);
		Tween.get(e).to({y: y/4}, 300);
		bg.onPress = addGameView;
		return false;
	}
	function movePaddle(e) {
		if (side === 'left') {
			leftPlayer.y = y - e.target.value;
		} else {
			rightPlayer.y = y - e.target.value;
		}
		let stageY = e.stageY < 0 ? 0: (e.stageY > y ? y : e.stageY);
		socketPingPong.timeout(100).emit('sendY', {
			gamer: document.querySelector('#gamer').value,
			y: e.target.value
		});
	}
        </script>
        
	</body>
</html>
